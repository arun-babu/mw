# kore-publisher configuration

#socket_backlog 10000

bind		0.0.0.0 8888
load		./kore-publisher.so init

tls_dhparam	dh2048.pem

worker_max_connections 50000 

http_request_ms 	3000

worker_accept_threshold 16
http_request_limit	50000

rand_file random.data

http_keepalive_time 20

worker_rlimit_nofiles	1000000

websocket_maxframe	65536
websocket_timeout 20
	
####################### security #######################

runas _kore_worker 
root jail 

keymgr_runas _kore_keymgr 
keymgr_root jail-keymgr 
 
########################################################

http_hsts_enable 0

domain * {

	certfile	cert/certificate.pem
	certkey		cert/key.pem

	client_verify		iudx-certificate.pem	
	client_verify_depth	3

	validator 	v_entity 	regex 	^[-a-zA-Z0-9]+[/][-a-zA-Z0-9]+$
	validator 	v_user 		regex 	^[-a-zA-Z0-9/]+$
	validator 	v_apikey 	regex 	^[-a-zA-Z0-9]+$
	validator 	v_string	regex 	^[-a-zA-Z0-9 ]+$
	validator 	v_search_string	regex 	^[-a-zA-Z0-9 \.#,]+$
	validator 	v_pattern	regex 	^[-a-zA-Z0-9\.]+$

        static          /				asset_serve_home_html	
        restrict        /				get

        static          /ws				serve_websocket
        restrict        /ws				get

	static 		/entity/publish			publish	
	restrict 	/entity/publish			post

	static 		/entity/publish-async		publish_async
	restrict 	/entity/publish-async		post

	static 		/entity/subscribe		subscribe
	restrict 	/entity/subscribe		get

	static 		/provider/entities			get_entities
	restrict 	/provider/entities			get	

	static 		/provider/register-entity		register_entity
	restrict 	/provider/register-entity		post

	static 		/provider/deregister-entity	deregister_entity
	restrict 	/provider/deregister-entity	post	

	static 		/provider/set-autonomous		set_autonomous	
	restrict 	/provider/set-autonomous		post	

	static 		/catalog			catalog
	restrict 	/catalog			get

	static 		/search-catalog			search_catalog
	restrict 	/search-catalog			get

	params qs:get /search-catalog {
		validate	id 	v_entity
		validate	tag 	v_string
		validate	key	v_pattern
		validate	value	v_search_string
	}

	static 		/catalog-tags			catalog_tags	
	restrict 	/catalog-tags			get

	static		/admin/providers		get_providers	
	restrict 	/admin/providers		get

	static		/provider/register		register_provider
	restrict 	/provider/register		get post	

	static		/provider/deregister		deregister_provider
	restrict 	/provider/deregister		post	

	static		/provider/follow		follow
	restrict 	/provider/follow		post	

	static		/entity/follow			follow
	restrict 	/entity/follow			post	

	static		/entity/unfollow		unfollow
	restrict 	/entity/unfollow		post	

	static		/provider/unfollow		unfollow
	restrict 	/provider/unfollow		post	

	static		/provider/follow-requests	get_follow_requests	
	restrict 	/provider/follow-requests	get

	static		/entity/follow-requests		get_follow_requests	
	restrict 	/entity/follow-requests		get
	
	static		/provider/follow-status		get_follow_status 
	restrict 	/provider/follow-status		get

	static		/entity/follow-status		get_follow_status 
	restrict 	/entity/follow-status		get

	static		/provider/share			share
	restrict 	/provider/share			post	

	static		/entity/share			share
	restrict 	/entity/share			post	

	static		/provider/reject-follow		reject_follow	
	restrict 	/provider/reject-follow		post	

	static		/entity/reject-follow		reject_follow	
	restrict 	/entity/reject-follow		post	
	
        static          /provider/bind                     queue_bind
        restrict        /provider/bind			post 

        static          /entity/bind                    queue_bind
        restrict        /entity/bind			post 

        static          /provider/unbind                   queue_unbind
        restrict        /provider/unbind			post 

        static          /entity/unbind                  queue_unbind
        restrict        /entity/unbind			post 

        static          /provider/block			block	
        restrict        /provider/block			post	

        static          /admin/block			block	
        restrict        /admin/block			post	

        static          /provider/unblock			unblock
        restrict        /provider/unblock			post	

        static          /admin/unblock			unblock
        restrict        /admin/unblock			post	

        static          /entity/permissions 		permissions	
        restrict        /entity/permissions 		get

        static          /provider/permissions 		permissions	
        restrict        /provider/permissions 		get

	################################## UI ###################################### 

	static		/ui/pages/login			asset_serve_login_html

	static		/ui/pages/admin			asset_serve_admin_html
	static		/ui/pages/provider			asset_serve_provider_html
	static		/ui/pages/entity		asset_serve_entity_html

	static		/ui/pages/follow		asset_serve_follow_html
	static		/ui/pages/catalog		asset_serve_catalog_html

	static		/ui/pages/error/403		asset_serve_403_html
	static		/ui/pages/error/404		asset_serve_404_html

	############################################################################ 
}
